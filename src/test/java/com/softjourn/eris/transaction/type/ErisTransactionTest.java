package com.softjourn.eris.transaction.type;

import com.softjourn.eris.contract.ContractUnit;
import org.junit.Before;
import org.junit.Test;

import java.io.File;
import java.util.List;
import java.util.Scanner;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;

/**
 * TransactionTest
 * Created by vromanchuk on 13.01.17.
 */
public class ErisTransactionTest {

    private String deployTransaction = "0201011490CCB0132FA9287AB3C3283978C0E523FA1450A0000000000000270F010101791D89860A6A44AAD5B03D9298DC578224E7A91AC047998A146AFF5870B157AAD4F196EA3DB7562E07783FA9C297BAD4FA7271610649657CA54E1048D497A50801CE92BABD1B4BEED36B5314DA468B2C16BE0E0380948C67ED2C352ADD8099E6730000000000423A35C700000000000004D20205C560606040526105B3806100126000396000F360606040526000357C0100000000000000000000000000000000000000000000000000000000900480638F4FFCB11461005A578063BC032BCE146100CB578063D2C80DBC14610100578063F3FEF3A31461013557610058565B005B6100C96004808035906020019091908035906020019091908035906020019091908035906020019082018035906020019191908080601F016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091905050610195565B005B6100EA60048080359060200190919080359060200190919050506101AC565B6040518082815260200191505060405180910390F35B61011F600480803590602001909190803590602001909190505061016A565B6040518082815260200191505060405180910390F35B6101546004808035906020019091908035906020019091905050610372565B6040518082815260200191505060405180910390F35B6000600050602052816000526040600020600050602052806000526040600020600091509150505481565B60006101A283868661038C565B90505B5050505050565B600060006000600050600085815260200190815260200160002060005060008473FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF168152602001908152602001600020600050549050600081141561020C576000915061036B5661036A565B8273FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF1660405180807F7472616E7366657228616464726573732C75696E743235362900000000000000815260200150601901905060405180910390207C0100000000000000000000000000000000000000000000000000000000809104027C010000000000000000000000000000000000000000000000000000000090043383604051837C0100000000000000000000000000000000000000000000000000000000028152600401808373FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF168152602001828152602001925050506000604051808303816000876161DA5A03F192505050156103605760006000600050600086815260200190815260200160002060005060008573FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF168152602001908152602001600020600050819055506001915061036B56610369565B6000915061036B565B5B5B5092915050565B600061037F83338461038C565B9050610386565B92915050565B6000600060008573FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF1663DD62ED3E8630604051837C0100000000000000000000000000000000000000000000000000000000028152600401808373FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF1681526020018273FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF168152602001925050506020604051808303816000876161DA5A03F115610002575050506040518051906020015091508382101561044C57610002566105A9565B8573FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF166323B872DD863087604051847C0100000000000000000000000000000000000000000000000000000000028152600401808473FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF1681526020018373FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF16815260200182815260200193505050506020604051808303816000876161DA5A03F1156100025750505060405180519060200150504543428787604051808681526020018581526020018481526020018373FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF166C010000000000000000000000000281526014018281526020019550505050505060405180910390209050836000600050600083815260200190815260200160002060005060008873FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF168152602001908152602001600020600050819055508092506105AA565B5B5050939250505056";
    private String transactionBinary;
    private ErisTransaction transaction;
    private String abi;
    private String wrongAbi;

    @Before
    public void setUp() throws Exception {
        File file;

        file = new File("src/test/resources/json/coinsContractAbi.json");
        this.abi = new Scanner(file).useDelimiter("\\Z").next();

        file = new File("src/test/resources/json/wrong_abi.json");
        this.wrongAbi = new Scanner(file).useDelimiter("\\Z").next();

        file = new File("src/test/resources/TransactionBinary.txt");
        this.transactionBinary = new Scanner(file).useDelimiter("\\Z").next();

        this.transaction = new ErisTransaction(transactionBinary);
    }

    @Test
    public void newTransaction_NotNullTransaction() throws Exception {
        assertNotNull(transaction);
        System.out.println(transaction);
    }

    @Test(expected = StringIndexOutOfBoundsException.class)
    public void newTransaction_fakeString_StringIndexOutOfBoundsException() throws Exception {
        new ErisTransaction("fake transaction");
    }

    @Test
    public void getContractUnit_abi_unit() throws Exception {
        ContractUnit unit = transaction.getContractUnit(abi);
        assertNotNull(unit);
    }

    @Test
    public void parseCallingData_ContractUnit() throws Exception {
        ContractUnit unit = transaction.getContractUnit(abi);
        List<Object> parseData = transaction.parseCallingData(unit);
        assertNotNull(parseData);
        String expected = "[90CCB0132FA9287AB3C3283978C0E523FA1450A0, 110]";
        assertEquals(expected, parseData.toString());
    }

    @Test(expected = IllegalArgumentException.class)
    public void parseCallingData_WrongAbi_IllegalArgumentException() throws Exception {
        ContractUnit unit = transaction.getContractUnit(wrongAbi);
        transaction.parseCallingData(unit);
    }

    @Test
    public void generateTxCode() throws Exception {
        ErisTransaction erisTransaction = new ErisTransaction(transactionBinary);
        assertEquals(transactionBinary, erisTransaction.generateTxCode());
        System.out.println(erisTransaction.getContractAddress());
    }
}
